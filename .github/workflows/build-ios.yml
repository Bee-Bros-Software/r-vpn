name: Build iOS Client

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'

    - name: Install gomobile
      run: |
        go install golang.org/x/mobile/cmd/gomobile@latest
        gomobile init

    - name: Check for iOS project
      id: check-ios
      run: |
        if [ -d "client/ios" ] && [ -f "client/ios/NetBird/NetBird.xcodeproj/project.pbxproj" ]; then
          echo "has_ios=true" >> $GITHUB_OUTPUT
        else
          echo "has_ios=false" >> $GITHUB_OUTPUT
        fi

    - name: Build iOS framework
      if: steps.check-ios.outputs.has_ios == 'true'
      run: |
        cd client
        gomobile bind -target=ios -o ../build/RVPNKit.xcframework ./ios

    - name: Setup Xcode
      if: steps.check-ios.outputs.has_ios == 'true'
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Build iOS app (unsigned)
      if: steps.check-ios.outputs.has_ios == 'true'
      run: |
        cd client/ios/NetBird
        xcodebuild -scheme NetBird \
          -configuration Release \
          -destination 'generic/platform=iOS' \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          -archivePath ../../build/R-VPN.xcarchive \
          archive || echo "Build failed - signing required"

    - name: Create build info
      run: |
        cat > build/ios-build-info.md << EOF
        # iOS Build Information

        ## Status
        The iOS client requires code signing with an Apple Developer account to build.

        ## Setup Instructions

        ### Prerequisites
        1. Apple Developer Account
        2. Xcode installed locally
        3. Valid provisioning profile

        ### Building Locally
        \`\`\`bash
        cd client/ios/NetBird

        # Update bundle identifier in Xcode to net.rsoftware.rvpn.ios
        # Configure your development team

        # Build for device
        xcodebuild -scheme NetBird \
          -configuration Release \
          -destination 'generic/platform=iOS' \
          -archivePath ../build/R-VPN.xcarchive \
          archive

        # Export IPA for TestFlight
        xcodebuild -exportArchive \
          -archivePath ../build/R-VPN.xcarchive \
          -exportPath ../build/ \
          -exportOptionsPlist ExportOptions.plist
        \`\`\`

        ### TestFlight Distribution
        1. Create app in App Store Connect with bundle ID: \`net.rsoftware.rvpn.ios\`
        2. Build and archive in Xcode
        3. Upload to TestFlight via Xcode or \`xcrun altool\`
        4. Add internal testers (up to 10,000)
        5. Share TestFlight link with team

        ### Alternative: Enterprise Distribution
        If you have an Apple Developer Enterprise account, you can distribute outside TestFlight:
        1. Create an Enterprise provisioning profile
        2. Build with Enterprise certificate
        3. Host IPA on internal server
        4. Distribute via direct download link

        ## Automated Signing (Optional)
        To enable automatic iOS builds in GitHub Actions:
        1. Add Apple Developer credentials to GitHub Secrets
        2. Set up Fastlane Match for certificate management
        3. Update this workflow with signing configuration

        ---
        Built with ❤️ by R-Software
        EOF

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ios-build-info
        path: build/ios-build-info.md

    - name: Comment on commit (if iOS build skipped)
      if: steps.check-ios.outputs.has_ios == 'false'
      run: |
        echo "⚠️ iOS project structure not found or incomplete. iOS builds require manual setup."
        echo "See ios-build-info.md for instructions."
